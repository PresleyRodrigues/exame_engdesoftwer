<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitações - Sistema</title>
    <link rel="stylesheet" href="p5.css">
    <style>
        .btn-atualizar {
            background-color: #28a745; /* Verde para destacar */
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        .btn-atualizar:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<nav class="menu-principal">
    <a href="p2.html" class="solicitante">Solicitações</a>
    <a href="p3.html" class="estoque">Estoque</a>
    <a href="p4.html" class="tecnico">Técnicos</a>
    <a href="p6.html" class="relatorio">Relatório</a>
    <div class="user-info">
        <span id="username-display"></span>
        <button onclick="logout()" class="logout-btn">Sair</button>
    </div>
</nav>

<main>
    <h1>Gerenciamento de Solicitações</h1>

    <section class="nova-solicitacao" id="solicitacaoSection">
        <h2>Nova Solicitação</h2>
        <form id="solicitacaoForm">
            <div class="form-group">
                <label>Solicitante:</label>
                <input type="text" name="solicitante" required>
            </div>
            <div class="form-group">
                <label>Equipamento:</label>
                <input type="text" name="equipamento" required>
            </div>
            <div class="form-group">
                <label>Prioridade:</label>
                <select name="prioridade">
                    <option>Alta</option>
                    <option>Média</option>
                    <option>Baixa</option>
                </select>
            </div>
            <button type="submit">Enviar Solicitação</button>
        </form>
    </section>

    <section class="lista-solicitacoes">
        <h2>Solicitações Ativas</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Solicitante</th>
                    <th>Equipamento</th>
                    <th>Prioridade</th>
                    <th>Técnico</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="solicitacoesTable"></tbody>
        </table>
    </section>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const username = localStorage.getItem('username');

        // Esconder o formulário para técnicos e gestores
        if (username !== 'solicitante') {
            document.getElementById('solicitacaoSection').style.display = 'none';
        }

        document.getElementById('username-display').textContent = `Olá, ${username}`;

        let solicitacoes = JSON.parse(localStorage.getItem('solicitacoes')) || [];

        function gerarId() {
            return solicitacoes.length > 0 ? Math.max(...solicitacoes.map(s => s.id)) + 1 : 1;
        }

        document.getElementById('solicitacaoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const novaSolicitacao = {
                id: gerarId(),
                solicitante: formData.get('solicitante'),
                equipamento: formData.get('equipamento'),
                prioridade: formData.get('prioridade'),
                tecnicoId: null,
                tecnicoNome: null,
                status: 'em espera'
            };
            solicitacoes.push(novaSolicitacao);
            localStorage.setItem('solicitacoes', JSON.stringify(solicitacoes));
            renderizarSolicitacoes();
            e.target.reset();
        });

        function carregarTecnicos() {
            return JSON.parse(localStorage.getItem('tecnicos')) || [];
        }

        function renderizarSolicitacoes() {
            const tbody = document.getElementById('solicitacoesTable');
            tbody.innerHTML = solicitacoes.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.solicitante}</td>
                    <td>${s.equipamento}</td>
                    <td><span class="prioridade ${s.prioridade.toLowerCase()}">${s.prioridade}</span></td>
                    <td>${getTecnicoSelector(s)}</td>
                    <td>${getStatusSelector(s)}</td>
                    <td>
                        <button onclick="atualizarSolicitacao(${s.id})" class="btn-atualizar">Atualizar</button>
                        <button onclick="deletarSolicitacao(${s.id})" class="btn-excluir">Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        function getTecnicoSelector(solicitacao) {
            const tecnicosDisponiveis = carregarTecnicos();
            return `
                <select id="tecnico-${solicitacao.id}">
                    <option value="">Selecione um técnico</option>
                    ${tecnicosDisponiveis.map(t => `
                        <option value="${t.id}" ${t.id === solicitacao.tecnicoId ? 'selected' : ''}>${t.nome}</option>
                    `).join('')}
                </select>
            `;
        }

        function getStatusSelector(solicitacao) {
            return `
                <select id="status-${solicitacao.id}">
                    <option value="em espera" ${solicitacao.status === 'em espera' ? 'selected' : ''}>Em Espera</option>
                    <option value="em andamento" ${solicitacao.status === 'em andamento' ? 'selected' : ''}>Em Andamento</option>
                    <option value="concluido" ${solicitacao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                </select>
            `;
        }

        function atualizarSolicitacao(id) {
            let solicitacao = solicitacoes.find(s => s.id === id);
            let tecnicoSelect = document.getElementById(`tecnico-${id}`);
            let statusSelect = document.getElementById(`status-${id}`);

            if (tecnicoSelect) {
                let tecnicoId = tecnicoSelect.value;
                let tecnicos = carregarTecnicos();
                let tecnico = tecnicos.find(t => t.id == tecnicoId);
                if (tecnico) {
                    solicitacao.tecnicoId = tecnicoId;
                    solicitacao.tecnicoNome = tecnico.nome;
                    solicitacao.status = 'em andamento';
                }
            }

            if (statusSelect) {
                solicitacao.status = statusSelect.value;
            }

            localStorage.setItem('solicitacoes', JSON.stringify(solicitacoes));
            renderizarSolicitacoes();
        }

        function deletarSolicitacao(id) {
            solicitacoes = solicitacoes.filter(s => s.id !== id);
            localStorage.setItem('solicitacoes', JSON.stringify(solicitacoes));
            renderizarSolicitacoes();
        }

        renderizarSolicitacoes();
    });

    function logout() {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('username');
        window.location.href = 'index.html';
    }

    window.atualizarSolicitacao = atualizarSolicitacao;
    window.deletarSolicitacao = deletarSolicitacao;
</script>

</body>
</html>