<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitações - Sistema</title>
    <link rel="stylesheet" href="p5.css">
</head>
<body>

<nav class="menu-principal">
    <a href="p2.html" class="solicitante">Solicitações</a>
    <a href="p3.html" class="estoque">Estoque</a>
    <a href="p4.html" class="tecnico">Técnicos</a>
    <a href="p6.html" class="relatorio">Relatório</a>
    <div class="user-info">
        <span id="username-display"></span>
        <button onclick="logout()" class="logout-btn">Sair</button>
    </div>
</nav>

<main>
    <h1>Gerenciamento de Solicitações</h1>

    <section class="nova-solicitacao" id="solicitacaoSection">
        <h2>Nova Solicitação</h2>
        <form id="solicitacaoForm">
            <div class="form-group">
                <label>Solicitante:</label>
                <input type="text" name="solicitante" required>
            </div>
            <div class="form-group">
                <label>Equipamento:</label>
                <input type="text" name="equipamento" required>
            </div>
            <div class="form-group">
                <label>Prioridade:</label>
                <select name="prioridade">
                    <option>Alta</option>
                    <option>Média</option>
                    <option>Baixa</option>
                </select>
            </div>
            <button type="submit">Enviar Solicitação</button>
        </form>
    </section>

    <section class="lista-solicitacoes">
        <h2>Solicitações Ativas</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Solicitante</th>
                    <th>Equipamento</th>
                    <th>Prioridade</th>
                    <th>Técnico</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="solicitacoesTable"></tbody>
        </table>
    </section>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const username = localStorage.getItem('username');
        const equipamentos = JSON.parse(localStorage.getItem('equipamentos')) || [];
        let solicitacoes = JSON.parse(localStorage.getItem('solicitacoes')) || [];

        if (username !== 'solicitante') {
            document.getElementById('solicitacaoSection').style.display = 'none';
        }

        document.getElementById('username-display').textContent = `Olá, ${username}`;

        function carregarTecnicos() {
            return JSON.parse(localStorage.getItem('tecnicos')) || [];
        }

        function renderizarSolicitacoes() {
            const tbody = document.getElementById('solicitacoesTable');
            tbody.innerHTML = solicitacoes.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.solicitante}</td>
                    <td>${s.equipamento}</td>
                    <td><span class="prioridade ${s.prioridade.toLowerCase()}">${s.prioridade}</span></td>
                    <td>
                        ${username === 'gestor' ? getTecnicoSelector(s) : s.tecnicoNome || 'Não atribuído'}
                        ${username === 'gestor' && s.tecnicoNome ? `<button onclick="atualizarDados(${s.id})">Atualizar Dados</button>` : ''}
                    </td>
                    <td>
                        ${username === 'técnico' ? getStatusSelector(s) : s.status}
                        ${username === 'técnico' ? `<button onclick="atualizarSolicitacao(${s.id})">Atualizar Solicitação</button>` : ''}
                    </td>
                    <td>
                        ${username === 'gestor' ? `<button onclick="verificarEquipamento('${s.equipamento}')">Verificar Equipamento</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getTecnicoSelector(solicitacao) {
            const tecnicos = carregarTecnicos().filter(t => t.status === 'Disponível');
            return `
                <select id="tecnico-${solicitacao.id}">
                    <option value="">Selecione um técnico</option>
                    ${tecnicos.map(t => `
                        <option value="${t.id}" ${t.id === solicitacao.tecnicoId ? 'selected' : ''}>${t.nome}</option>
                    `).join('')}
                </select>
            `;
        }

        function getStatusSelector(solicitacao) {
            return `
                <select id="status-${solicitacao.id}">
                    <option value="em espera" ${solicitacao.status === 'em espera' ? 'selected' : ''}>Em Espera</option>
                    <option value="em andamento" ${solicitacao.status === 'em andamento' ? 'selected' : ''}>Em Andamento</option>
                    <option value="concluido" ${solicitacao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                </select>
            `;
        }

        function atualizarSolicitacao(id) {
            const status = document.getElementById(`status-${id}`).value;
            let solicitacao = solicitacoes.find(s => s.id === id);

            if (solicitacao) {
                solicitacao.status = status;

                if (status === 'concluido') {
                    alert('Equipamento entregue com sucesso!');
                    liberarTecnico(solicitacao.tecnicoId);
                }

                localStorage.setItem('solicitacoes', JSON.stringify(solicitacoes));
                renderizarSolicitacoes();
            }
        }

        function liberarTecnico(tecnicoId) {
            let tecnicos = carregarTecnicos();
            let tecnico = tecnicos.find(t => t.id == tecnicoId);

            if (tecnico) {
                tecnico.status = 'Disponível';
                localStorage.setItem('tecnicos', JSON.stringify(tecnicos));
            }
        }

        function verificarEquipamento(nomeEquipamento) {
            const equipamentoExiste = equipamentos.some(eq => eq.nome === nomeEquipamento);

            if (!equipamentoExiste) {
                alert('Nota de compra feita com sucesso.');
            } else {
                alert('Equipamento disponível no estoque.');
            }
        }

        function atualizarDados(id) {
            const tecnicoId = document.getElementById(`tecnico-${id}`).value;
            let tecnicos = carregarTecnicos();
            let tecnico = tecnicos.find(t => t.id == tecnicoId);
            let solicitacao = solicitacoes.find(s => s.id === id);

            if (solicitacao && tecnico) {
                solicitacao.tecnicoId = tecnicoId;
                solicitacao.tecnicoNome = tecnico.nome;
                solicitacao.status = 'em andamento';
                tecnico.status = 'Ocupado';

                localStorage.setItem('solicitacoes', JSON.stringify(solicitacoes));
                localStorage.setItem('tecnicos', JSON.stringify(tecnicos));
                alert('Técnico designado com sucesso!');
                renderizarSolicitacoes();
            }
        }

        renderizarSolicitacoes();
    });

    function logout() {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('username');
        window.location.href = 'index.html';
    }
</script>

</body>
</html>